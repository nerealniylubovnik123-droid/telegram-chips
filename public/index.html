<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chips Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {font-family:system-ui;background:#0e1117;color:#e6edf3;margin:0;padding:20px;}
    button {background:#2f81f7;border:none;padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;margin:4px 0;}
    input {padding:8px;border-radius:8px;border:1px solid #30363d;background:#161b22;color:#e6edf3;width:100%;box-sizing:border-box;}
    .card {background:#161b22;padding:16px;border-radius:12px;margin:10px 0;}
    h2 {margin:8px 0;}
    pre {background:#0b0f14;padding:8px;border-radius:8px;white-space:pre-wrap;font-size:13px;}
    .hidden {display:none;}
  </style>
</head>
<body>
  <h1>üé≤ Chips Game</h1>
  <div id="screenStart">
    <button id="btnStart">–ù–∞—á–∞—Ç—å / –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
  </div>

  <div id="screenRole" class="hidden">
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</h2>
    <button id="asAdmin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
    <button id="asPlayer">–ò–≥—Ä–æ–∫</button>
  </div>

  <div id="screenAdmin" class="hidden">
    <h2>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h2>
    <div class="card">
      <button id="btnSummary">–û–±—â–∞—è —Å–≤–æ–¥–∫–∞</button>
      <button id="btnEnd">–ó–∞–∫–æ–Ω—á–∏—Ç—å –∏–≥—Ä—É</button>
    </div>
    <pre id="adminOut"></pre>
  </div>

  <div id="screenPlayer" class="hidden">
    <h2>–ò–≥—Ä–æ–∫</h2>
    <div class="card">
      <input id="chipsInput" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫">
      <button id="btnReq">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–∏—à–∫–∏</button>
      <button id="btnReturn">–í–µ—Ä–Ω—É—Ç—å —Ñ–∏—à–∫–∏</button>
    </div>
    <pre id="playerOut"></pre>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    const $ = (id) => document.getElementById(id);
    const log = (el, obj) => el.textContent = typeof obj==='string'?obj:JSON.stringify(obj,null,2);

    const initData = tg?.initData || "";
    const initDataUnsafe = JSON.stringify(tg?.initDataUnsafe || {});

    async function api(path, bodyObj={}) {
      bodyObj.__initData = initData;
      bodyObj.__initDataUnsafe = initDataUnsafe;
      const res = await fetch(path, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(bodyObj)
      });
      return await res.json();
    }

    let currentRole = null;

    $('btnStart').onclick = async ()=>{
      const r = await api('/api/game/start');
      if(r.ok){
        $('screenStart').classList.add('hidden');
        $('screenRole').classList.remove('hidden');
      } else alert(r.error);
    };

    $('asAdmin').onclick = ()=>{currentRole='admin';$('screenRole').classList.add('hidden');$('screenAdmin').classList.remove('hidden');};
    $('asPlayer').onclick = ()=>{currentRole='player';$('screenRole').classList.add('hidden');$('screenPlayer').classList.remove('hidden');};

    // --- ADMIN ACTIONS ---
    $('btnSummary').onclick = async ()=>{
      const r = await fetch('/api/admin/summary',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({__initData:initData,__initDataUnsafe:initDataUnsafe})});
      const j = await r.json();
      log($('adminOut'), j);
    };

    $('btnEnd').onclick = async ()=>{
      const r = await api('/api/admin/end');
      log($('adminOut'), r);
    };

    // --- PLAYER ACTIONS ---
    $('btnReq').onclick = async ()=>{
      const amt = parseInt($('chipsInput').value||'0');
      if(amt<=0)return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ >0');
      const r = await api('/api/player/request',{amount:amt,type:'request'});
      log($('playerOut'), r);
    };
    $('btnReturn').onclick = async ()=>{
      const amt = parseInt($('chipsInput').value||'0');
      if(amt<=0)return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ >0');
      const r = await api('/api/player/request',{amount:amt,type:'return'});
      log($('playerOut'), r);
    };
  </script>
</body>
</html>
