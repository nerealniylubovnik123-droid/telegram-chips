<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>üé≤ Chips Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg0:#070a10; --bg1:#0b0f18; --bg2:#0e1420;
      --card:rgba(15,21,34,0.85); --line:#1a2434;
      --text:#eaf0ff; --muted:#9bb0c7;
      --acc:#00c2b3; --acc2:#67fff3; --danger:#ff4d6d;
      --shadow:0 18px 40px rgba(0,0,0,.45);
    }
    body[data-theme='light']{
      --bg0:#f6f8fc; --bg1:#f3f6fb; --bg2:#eef2f8;
      --card:rgba(255,255,255,0.85); --line:#d8e0ee;
      --text:#0a1630; --muted:#5c6b82;
      --acc:#00b3a4; --acc2:#21e6d4; --danger:#c43d55;
      --shadow:0 12px 30px rgba(16,24,40,.10);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      color:var(--text);
      font:16px/1.45 'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(120deg,var(--bg0),var(--bg1),var(--bg2));
      background-size:300% 300%;
      animation:bgMove 20s ease infinite;
      transition:background .4s ease,color .3s ease;
      padding:16px 12px 28px;
    }
    @keyframes bgMove{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .wrap{max-width:520px;margin:0 auto}
    .header{
      display:flex;align-items:center;gap:10px;
      position:sticky;top:0;z-index:5;
      background:color-mix(in oklab,var(--card) 86%, transparent 14%);
      backdrop-filter:blur(10px);
      border-radius:16px;
      padding:10px 12px;
      margin-bottom:16px;
      border:1px solid var(--line);
      box-shadow:0 2px 12px rgba(0,0,0,.3);
    }
    .logo{display:flex;align-items:center;gap:10px;font-weight:800}
    .ic-bubble{width:38px;height:38px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(180deg,#1fead9,#00b3a4);
      box-shadow:0 10px 24px rgba(0,179,164,.35);
    }
    .icon{width:18px;height:18px;vertical-align:-2px;stroke-width:2;stroke:currentColor;fill:none}
    .btn{appearance:none;border:1px solid var(--line);background:color-mix(in oklab,var(--card) 78%,var(--bg2) 22%);
      color:var(--text);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;transition:all .2s ease;display:inline-flex;align-items:center;gap:8px}
    .btn:hover{transform:translateY(-1px);border-color:var(--acc2)}
    .btn.primary{background:linear-gradient(180deg,var(--acc2),var(--acc));color:#041412;border-color:#0aa497}
    .btn.primary:hover{box-shadow:0 0 12px rgba(0,194,179,.35)}
    .btn.secondary{background:color-mix(in oklab,var(--card) 82%,var(--bg2) 18%);color:var(--text)}
    .btn.danger{background:linear-gradient(180deg,#ff6b81,#ff4d6d);color:#041412;border-color:#b42d4d}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:20px;padding:16px;box-shadow:var(--shadow);
      margin:12px 0;backdrop-filter:blur(8px);transition:transform .2s ease
    }
    .card:hover{transform:translateY(-1px)}
    input,select{
      padding:10px;border-radius:12px;border:1px solid var(--line);
      background:color-mix(in oklab,var(--card) 85%,var(--bg2) 15%);
      color:var(--text);width:100%;box-sizing:border-box
    }
    .badge{display:inline-block;min-width:18px;padding:2px 8px;border-radius:999px;
      background:color-mix(in oklab,#f0ad4e 30%, #0a0 0%);color:#111;font-weight:800;margin-left:6px}
    .role-label{text-align:center;padding:6px 0;font-size:14px;color:var(--muted)}
    .list{font-size:14px}
    .list div{padding:8px 12px;border-radius:12px;margin-bottom:6px;border:1px solid var(--line);
      background:color-mix(in oklab,var(--card) 85%,var(--bg2) 15%)}
    .status{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .status.approved{background:#2ea04322;color:#2ea043}
    .status.rejected{background:#da363322;color:#da3633}
    .status.pending{background:#f0ad4e22;color:#f0ad4e}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo">
      <div class="ic-bubble">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"></circle><path d="M12 7v10M7 12h10"></path></svg>
      </div>
      <div>Chips Game</div>
    </div>
    <div style="flex:1"></div>
    <button class="btn secondary" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" style="width:40px;height:40px;display:grid;place-items:center;padding:0">
      <svg class="icon" viewBox="0 0 24 24"><path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Z"></path><path d="M19.4 15a2 2 0 0 0 .4-1l1.6-1-1.6-1a2 2 0 0 0-.4-1l.6-1.6-1.6-.6a2 2 0 0 0-.8-.8l-.6-1.6-1.6.6a2 2 0 0 0-1-.4l-1-1.6-1 1.6a2 2 0 0 0-1 .4l-1.6-.6-.6 1.6a2 2 0 0 0-.8.8l-1.6.6.6 1.6a2 2 0 0 0-.4 1l-1.6 1 1.6 1a2 2 0 0 0 .4 1l-.6 1.6 1.6.6a2 2 0 0 0 .8.8l.6 1.6 1.6-.6a2 2 0 0 0 1 .4l1 1.6 1-1.6a2 2 0 0 0 1-.4l1.6.6.6-1.6a2 2 0 0 0 .8-.8l1.6-.6Z"></path></svg>
    </button>
  </div>

  <div id="screenStart">
    <button id="btnStart" class="btn primary"><svg class="icon"><use href="#i-plus"/></svg> –ù–∞—á–∞—Ç—å / –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    <button id="btnEndGlobal" class="btn danger" style="margin-top:10px"><svg class="icon"><use href="#i-stop"/></svg> –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
    <div class="card" style="margin-top:12px">
      <h3>–°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã</h3>
      <div id="gameInfo" class="list"></div>
    </div>
  </div>

  <div id="screenRole" class="hidden">
    <div class="card">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</h2>
      <div class="row">
        <button id="asAdmin" class="btn"><svg class="icon"><use href="#i-users"/></svg> –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
        <button id="asPlayer" class="btn secondary"><svg class="icon"><use href="#i-coin"/></svg> –ò–≥—Ä–æ–∫</button>
      </div>
    </div>
  </div>

  <div id="screenAdmin" class="hidden">
    <div class="role-label">üëë –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
    <div class="card">
      <div class="row">
        <input id="adminAmount" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫" />
        <button id="adminReqBtn" class="btn primary"><svg class="icon"><use href="#i-coin"/></svg> –í–∑—è—Ç—å</button>
        <button id="adminRetBtn" class="btn secondary"><svg class="icon"><use href="#i-coin"/></svg> –í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnRefresh" class="btn"><svg class="icon"><use href="#i-refresh"/></svg> –ó–∞—è–≤–∫–∏ <span id="badge" class="badge" style="display:none">0</span></button>
        <button id="btnSummary" class="btn secondary"><svg class="icon"><use href="#i-chart"/></svg> –ò—Ç–æ–≥–∏</button>
        <button id="btnPlayers" class="btn secondary"><svg class="icon"><use href="#i-users"/></svg> –ò–≥—Ä–æ–∫–∏ –∏ —Å—É–º–º—ã</button>
        <button id="btnGameHistory" class="btn secondary"><svg class="icon"><use href="#i-clock"/></svg> –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä–æ–∫–æ–≤</button>
        <button id="btnEnd" class="btn danger"><svg class="icon"><use href="#i-stop"/></svg> –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
      </div>
    </div>

    <div id="adminSectionRequests" class="card">
      <h3>üì© –ó–∞—è–≤–∫–∏ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="reqList"></div>
    </div>

    <div id="adminSectionPlayers" class="card hidden">
      <h3>üë• –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="playersList" class="list"></div>
      <div class="row" style="margin-top:10px">
        <select id="newAdminSelect"></select>
        <button id="btnChangeAdmin" class="btn">üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
      </div>
    </div>

    <div id="adminSectionGameHistory" class="card hidden">
      <h3>üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä–æ–∫–æ–≤ (—Ç–µ–∫—É—â–∞—è –∏–≥—Ä–∞)</h3>
      <div id="adminHistoryList" class="list"></div>
    </div>
  </div>

  <div id="screenPlayer" class="hidden">
    <div class="role-label">üéÆ –í—ã –∏–≥—Ä–æ–∫</div>
    <div class="card">
      <div class="row">
        <input id="chipsInput" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫">
        <button id="btnReq" class="btn primary"><svg class="icon"><use href="#i-coin"/></svg> –ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button id="btnReturn" class="btn secondary"><svg class="icon"><use href="#i-coin"/></svg> –í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>
    <div class="card">
      <h3>üßæ –ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
      <div id="myHistory" class="list"></div>
    </div>
    <div class="card">
      <h3>üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</h3>
      <div id="myGameHistory" class="list"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp; tg?.expand();
    if (tg?.colorScheme === 'light') document.body.dataset.theme = 'light';

    const $ = id => document.getElementById(id);
    const initData = tg?.initData || "";
    const initDataUnsafe = JSON.stringify(tg?.initDataUnsafe || {});
    const bodyWithAuth = (extra={}) => JSON.stringify(Object.assign({}, extra, {__initData:initData,__initDataUnsafe:initDataUnsafe}));

    async function post(path, payloadObj={}) {
      const res = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, body: bodyWithAuth(payloadObj) });
      return await res.json();
    }

    let currentRole = null;
    let adminUserId = null;
    let lastPendingCount = 0;

    async function loadGameInfo() {
      const box = $('gameInfo');
      box.innerHTML = '<span class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>';
      const r = await post('/api/game/info');
      if (!r.ok) { box.textContent = r.error || '–û—à–∏–±–∫–∞'; return; }
      if (!r.game) { box.innerHTML = '<div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã</div>'; return; }
      const a = r.admin;
      const who = `${a?.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}${a?.username ? ' @' + a.username : ''}`;
      box.innerHTML = `<div>–°—Ç–∞—Ç—É—Å: <b>–∞–∫—Ç–∏–≤–Ω–∞</b></div><div>–ê–¥–º–∏–Ω: <b>${who}</b></div>`;
      adminUserId = r.game.admin_user_id;
    }

    $('btnStart').onclick = async ()=>{
      const r = await post('/api/game/start');
      if(r.ok){
        $('screenStart').classList.add('hidden');
        $('screenRole').classList.remove('hidden');
        adminUserId = r.game.admin_user_id;
      } else alert(r.error);
    };

    $('btnEndGlobal').onclick = async ()=>{
      const r = await post('/api/admin/end');
      if(r.ok){
        alert('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        resetToStart();
      } else alert('–û—à–∏–±–∫–∞: ' + (r.error || ''));
    };

    $('asAdmin').onclick = ()=>switchRole('admin');
    $('asPlayer').onclick = ()=>switchRole('player');

    function switchRole(role){
      currentRole = role;
      window.isAdminActive = (role === 'admin');
      $('screenRole').classList.add('hidden');
      $('screenAdmin').classList.toggle('hidden', role!=='admin');
      $('screenPlayer').classList.toggle('hidden', role!=='player');
      if(role==='admin'){
        loadPending(); loadPlayers(); loadGameHistory(); startAdminPolling();
      } else {
        loadMyHistory(); loadGameHistory(); startPlayerPolling();
      }
    }

    $('btnGameHistory').onclick = ()=>{
      const box = $('adminSectionGameHistory');
      box.classList.toggle('hidden');
      if(!box.classList.contains('hidden')) loadAdminGameHistory();
    };

    $('btnReq').onclick = async ()=>handleRequest('request');
    $('btnReturn').onclick = async ()=>handleRequest('return');

    async function handleRequest(type){
      const amt = parseInt(($('chipsInput').value||'0'), 10);
      if(isNaN(amt) || amt < 0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ ‚â• 0');
      const r = await post('/api/player/request', {amount:amt, type});
      if(!r.ok) alert(r.error); else $('chipsInput').value='';
      loadMyHistory();
      if (window.isAdminActive) loadPending();
    }

    async function loadMyHistory(){
      const r = await post('/api/player/history');
      const box = $('myHistory');
      box.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.history?.length){ box.innerHTML = '<i>–ù–µ—Ç –∑–∞—è–≤–æ–∫</i>'; return; }
      for(const item of r.history){
        const iconId = item.status==='approved' ? 'i-approve' : item.status==='rejected' ? 'i-reject' : 'i-clock';
        const div=document.createElement('div');
        div.innerHTML = `<b>${item.type==='request'?'–ó–∞–ø—Ä–æ—Å':'–í–æ–∑–≤—Ä–∞—Ç'}</b> ¬∑ ${item.amount}
          <span class="status ${item.status}"><svg class="icon"><use href="#${iconId}"/></svg>${item.status}</span>`;
        box.appendChild(div);
      }
    }

    async function loadGameHistory(){
      const r = await post('/api/player/game-history');
      const box = $('myGameHistory');
      box.innerHTML = '';
      if(!r.ok){ box.textContent = r.error || '–û—à–∏–±–∫–∞'; return; }
      const arr = r.history || [];
      if(!arr.length){ box.innerHTML = '<i>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</i>'; return; }
      for (const it of arr) {
        const delta = Number(it.delta) || 0;
        const color = delta >= 0 ? '#2ea043' : '#da3633';
        const sign = delta >= 0 ? '+' : '';
        const dateStr = it.created_at ? new Date(it.created_at.replace(' ', 'T')).toLocaleDateString() : '';
        const row = document.createElement('div');
        row.innerHTML = `${dateStr} ‚Äî <b style="color:${color}">${sign}${Math.abs(delta)}</b> <span class="muted">(–∏—Ç–æ–≥: ${it.total})</span>`;
        box.appendChild(row);
      }
      const lastTotal = arr[0]?.total ?? 0;
      const sum = document.createElement('div');
      const sumColor = lastTotal >= 0 ? '#2ea043' : '#da3633';
      sum.innerHTML = `<b>–ò—Ç–æ–≥–æ –ø–æ –≤—Å–µ–º –∏–≥—Ä–∞–º:</b> <span style="color:${sumColor}">${lastTotal >= 0 ? '+' : ''}${lastTotal}</span>`;
      box.appendChild(sum);
    }

    async function loadAdminGameHistory(){
      const r = await post('/api/admin/game-history');
      const list = $('adminHistoryList');
      list.innerHTML = '';
      if(!r.ok){ list.textContent = r.error || '–û—à–∏–±–∫–∞'; return; }
      const players = r.players || [];
      if(!players.length){ list.innerHTML = '<i>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</i>'; return; }
      for (const p of players){
        const header = document.createElement('div');
        const totalColor = p.total >= 0 ? '#2ea043' : '#da3633';
        const who = `${p.first_name || '–ò–≥—Ä–æ–∫'}${p.username ? ' @'+p.username : ''}`;
        header.innerHTML = `<b>${who}</b> ‚Äî –∏—Ç–æ–≥: <b style="color:${totalColor}">${p.total >= 0 ? '+' : ''}${p.total}</b>`;
        list.appendChild(header);
        for (const e of p.entries){
          const color = e.delta >= 0 ? '#2ea043' : '#da3633';
          const dateStr = e.requested_at ? new Date(e.requested_at.replace(' ','T')).toLocaleString() : '';
          const row = document.createElement('div');
          row.style.paddingLeft = '10px';
          row.innerHTML = `${dateStr} ‚Äî ${e.type==='request' ? '–ó–∞–ø—Ä–æ—Å' : '–í–æ–∑–≤—Ä–∞—Ç'}: <b style="color:${color}">${e.delta >= 0 ? '+' : ''}${Math.abs(e.delta)}</b>`;
          list.appendChild(row);
        }
      }
    }

    $('adminReqBtn').onclick = async ()=>adminRequest('request');
    $('adminRetBtn').onclick = async ()=>adminRequest('return');
    async function adminRequest(type){
      const amt = parseInt(($('adminAmount').value||'0'), 10);
      if(isNaN(amt) || amt < 0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ ‚â• 0');
      const r = await post('/api/player/request', {amount:amt, type});
      if(!r.ok) alert(r.error); else $('adminAmount').value='';
      loadPending();
    }

    $('btnRefresh').onclick = loadPending;
    $('btnPlayers').onclick = ()=>{
      $('adminSectionPlayers').classList.toggle('hidden');
      if(!$('adminSectionPlayers').classList.contains('hidden')) loadPlayers();
    };
    $('btnEnd').onclick = async ()=>{
      const r = await post('/api/admin/end');
      if (r.ok) { alert('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'); resetToStart(); }
      else { alert('–û—à–∏–±–∫–∞: ' + r.error); }
    };
    $('btnChangeAdmin').onclick = async ()=>{
      const val = $('newAdminSelect').value;
      if(!val) return;
      const r = await post('/api/admin/change', { new_admin_user_id: val });
      if(r.ok){ adminUserId = val; alert('‚úÖ –ê–¥–º–∏–Ω –∏–∑–º–µ–Ω—ë–Ω'); } else alert(r.error);
    };
    $('btnSummary').onclick = async ()=>{
      const r = await post('/api/admin/summary');
      if(r.ok){
        const list = (r.transfers || []).join('\\n');
        alert(list || '–í—Å–µ —Ä–∞—Å—á—ë—Ç—ã —Å–≤–µ–¥–µ–Ω—ã, –¥–æ–ª–≥–æ–≤ –Ω–µ—Ç.');
      } else alert('–û—à–∏–±–∫–∞: ' + (r.error || ''));
    };

    async function loadPending(){
      const r = await post('/api/admin/pending');
      const list = $('reqList'), badge = $('badge');
      list.innerHTML = '';
      if(!r.ok){ list.textContent = r.error; badge.style.display='none'; return; }
      const items = r.requests || [];
      if(items.length===0){ badge.style.display='none'; } else { badge.textContent = items.length; badge.style.display='inline-block'; }
      if(items.length===0){
        list.innerHTML = '<i>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</i>';
        return;
      }
      for(const it of items){
        const el = document.createElement('div');
        el.className = `req ${it.status}`;
        el.innerHTML = `<b>${it.first_name||'–ò–≥—Ä–æ–∫'} ${it.username?('@'+it.username):''}</b><br>
        ${it.type==='request'?'–ü—Ä–æ—Å–∏—Ç':'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç'} <b>${it.amount}</b> —Ñ–∏—à–µ–∫
        <div class="row" style="margin-top:6px">
          <button data-id="${it.id}" data-s="approved" class="btn"><svg class="icon"><use href="#i-approve"/></svg> –û–¥–æ–±—Ä–∏—Ç—å</button>
          <button class="btn secondary" data-id="${it.id}" data-s="rejected"><svg class="icon"><use href="#i-reject"/></svg> –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>`;
        list.appendChild(el);
      }
      list.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = +btn.dataset.id, status = btn.dataset.s;
          const r = await post('/api/admin/decide', {id, status});
          if(!r.ok) alert(r.error);
          loadPending(); loadPlayers();
        };
      });
    }

    async function loadPlayers(){
      const r = await post('/api/admin/players');
      const box = $('playersList'), sel = $('newAdminSelect');
      box.innerHTML = ''; sel.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.players?.length){ box.innerHTML = '<i>–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</i>'; return; }
      for(const p of r.players){
        const color = p.diff>0?'#2ea043':p.diff<0?'#da3633':'#f0ad4e';
        const row = document.createElement('div');
        row.innerHTML = `<b>${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}</b> ‚Äî –≤—ã–¥–∞–Ω–æ: <b>${p.issued}</b>, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ: <b>${p.returned}</b>, –∏—Ç–æ–≥: <b style="color:${color}">${p.diff}</b>`;
        box.appendChild(row);
        const opt = document.createElement('option');
        opt.value = p.user_id;
        opt.textContent = `${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}`;
        sel.appendChild(opt);
      }
    }

    function resetToStart(){
      clearAll();
      currentRole = null;
      adminUserId = null;
      $('screenAdmin').classList.add('hidden');
      $('screenPlayer').classList.add('hidden');
      $('screenRole').classList.add('hidden');
      $('screenStart').classList.remove('hidden');
      loadGameInfo();
      alert('üõë –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é.');
    }

    async function checkRoleChange(){
      const r = await post('/api/game/start');
      if (r.ok && r.game) {
        if (r.game.status === 'ended') { resetToStart(); return; }
      }
    }

    let playerTimer, adminTimer, roleTimer;
    function startPlayerPolling(){
      clearAll();
      loadMyHistory();
      loadGameHistory();
      playerTimer = setInterval(()=>{ loadMyHistory(); loadGameHistory(); }, 5000);
      roleTimer = setInterval(checkRoleChange, 5000);
    }
    function startAdminPolling(){
      clearAll();
      loadPending();
      adminTimer = setInterval(()=>{ loadPending(); checkRoleChange(); }, 5000);
    }
    function clearAll(){
      clearInterval(playerTimer); clearInterval(adminTimer); clearInterval(roleTimer);
    }

    loadGameInfo();
  </script>

  <!-- SVG sprite -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="i-plus" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></symbol>
    <symbol id="i-minus" viewBox="0 0 24 24"><path d="M5 12h14"/></symbol>
    <symbol id="i-coin" viewBox="0 0 24 24"><ellipse cx="12" cy="8" rx="7" ry="3"/><path d="M5 8v8c0 1.7 3.1 3 7 3s7-1.3 7-3V8"/></symbol>
    <symbol id="i-refresh" viewBox="0 0 24 24"><path d="M20 11a8 8 0 1 1-2.3-5.7L20 8M20 4v4h-4"/></symbol>
    <symbol id="i-users" viewBox="0 0 24 24"><path d="M16 11a4 4 0 1 0-8 0 4 4 0 0 0 8 0Z"/><path d="M3 20a7 7 0 0 1 18 0"/></symbol>
    <symbol id="i-chart" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 15v3M12 11v7M17 6v12"/></symbol>
    <symbol id="i-stop" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></symbol>
    <symbol id="i-approve" viewBox="0 0 24 24"><path d="M5 12l4 4 10-10"/></symbol>
    <symbol id="i-reject" viewBox="0 0 24 24"><path d="M6 6l12 12M6 18L18 6"/></symbol>
    <symbol id="i-clock" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M12 7v6l4 2"/></symbol>
  </svg>
</div>
</body>
</html>
