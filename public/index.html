<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé≤ Chips Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-dark: #0d1117; --bg-card:#161b22; --border:#30363d; --text:#e6edf3;
      --accent:#2f81f7; --green:#2ea043; --red:#da3633; --yellow:#f0ad4e;
    }
    body{font-family:system-ui;background:linear-gradient(180deg,#0d1117 0%,#111820 100%);color:var(--text);margin:0;padding:20px}
    h1{text-align:center;color:var(--accent);margin:0 0 16px}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:10px 0;box-shadow:0 4px 10px rgba(0,0,0,.25)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:#30363d}
    input,select{background:#161b22;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px;width:100%;box-sizing:border-box}
    .hidden{display:none}
    .req{background:#1b212c;padding:10px;border-radius:10px;margin:6px 0;border-left:4px solid var(--yellow)}
    .badge{display:inline-block;min-width:18px;padding:2px 6px;border-radius:999px;background:var(--yellow);color:#111;font-weight:700;margin-left:6px}
    .list{font-size:14px}.list div{padding:6px 0;border-bottom:1px solid #2a313b}
    .role-label{text-align:center;color:var(--yellow);margin-bottom:6px}
  </style>
</head>
<body>
  <h1>üé≤ Chips Game</h1>

  <div id="screenStart">
    <button id="btnStart">–ù–∞—á–∞—Ç—å / –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
  </div>

  <div id="screenRole" class="hidden">
    <div class="card">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</h2>
      <div class="row">
        <button id="asAdmin">üß© –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
        <button id="asPlayer">üéÆ –ò–≥—Ä–æ–∫</button>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="screenAdmin" class="hidden">
    <div class="role-label">üëë –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>

    <div class="card">
      <div class="row">
        <input id="adminAmount" type="number" placeholder="–°–∫–æ–ª—å–∫–æ —Ñ–∏—à–µ–∫" />
        <button id="adminReqBtn">üí∞ –í–∑—è—Ç—å</button>
        <button id="adminRetBtn" class="secondary">‚ôªÔ∏è –í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnRefresh">üîÑ –ó–∞—è–≤–∫–∏ <span id="badge" class="badge" style="display:none">0</span></button>
        <button id="btnPlayers" class="secondary">üë• –ò–≥—Ä–æ–∫–∏ –∏ —Å—É–º–º—ã</button>
        <button id="btnEnd" class="secondary">üõë –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
      </div>
    </div>

    <div id="adminSectionRequests" class="card">
      <h3>üì© –ó–∞—è–≤–∫–∏ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="reqList"></div>
    </div>

    <div id="adminSectionPlayers" class="card hidden">
      <h3>üë• –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="playersList" class="list"></div>
      <div class="row" style="margin-top:10px">
        <select id="newAdminSelect"></select>
        <button id="btnChangeAdmin">üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
      </div>
    </div>
  </div>

  <!-- PLAYER -->
  <div id="screenPlayer" class="hidden">
    <div class="role-label">üéÆ –í—ã –∏–≥—Ä–æ–∫</div>
    <div class="card">
      <div class="row">
        <input id="chipsInput" type="number" placeholder="–°–∫–æ–ª—å–∫–æ —Ñ–∏—à–µ–∫">
        <button id="btnReq">üí∞ –ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button id="btnReturn" class="secondary">‚ôªÔ∏è –í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>
    <div class="card">
      <h3>üßæ –ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
      <div id="myHistory" class="list"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp; tg?.expand();
    const $ = id => document.getElementById(id);

    const initData = tg?.initData || "";
    const initDataUnsafe = JSON.stringify(tg?.initDataUnsafe || {});
    const userId = tg?.initDataUnsafe?.user?.id;

    const bodyWithAuth = (extra={}) => JSON.stringify(Object.assign({}, extra, {__initData:initData,__initDataUnsafe:initDataUnsafe}));
    async function post(path, payloadObj={}) {
      const res = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, body: bodyWithAuth(payloadObj) });
      return await res.json();
    }

    let currentRole = null;
    let adminUserId = null;
    let es = null; // EventSource

    function connectSSE(){
      try {
        // –ø–µ—Ä–µ–¥–∞—ë–º initData –≤ query (SSE = GET)
        const url = new URL('/api/stream', window.location.origin);
        url.searchParams.set('initData', tg?.initData || '');
        url.searchParams.set('initDataUnsafe', JSON.stringify(tg?.initDataUnsafe || {}));
        es = new EventSource(url.toString(), { withCredentials:false });

        es.addEventListener('hello', e => {
          // console.debug('SSE hello', e.data);
        });

        es.addEventListener('new_request', e => {
          // –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –∑–∞—è–≤–æ–∫
          if (currentRole === 'admin') loadPending();
          // –±–µ–π–¥–∂–∏–∫ –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å loadPending
        });

        es.addEventListener('queue_update', e => {
          if (currentRole === 'admin') loadPending();
        });

        es.addEventListener('admin_changed', e => {
          try {
            const data = JSON.parse(e.data || '{}');
            adminUserId = data.admin_user_id;
            const isNowAdmin = String(adminUserId) === String(userId);
            if (isNowAdmin && currentRole !== 'admin') {
              alert('üéâ –í—ã —Å—Ç–∞–ª–∏ –Ω–æ–≤—ã–º –∞–¥–º–∏–Ω–æ–º');
              switchRole('admin');
            } else if (!isNowAdmin && currentRole === 'admin') {
              alert('–ê–¥–º–∏–Ω –∏–∑–º–µ–Ω—ë–Ω, –≤—ã –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω');
              switchRole('player');
            }
          } catch {}
        });

        es.addEventListener('game_ended', e => {
          alert('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
          window.location.reload();
        });

        es.onerror = () => {
          // –∞–≤—Ç–æ–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1.5—Å
          try { es.close(); } catch {}
          setTimeout(connectSSE, 1500);
        };
      } catch (e) {
        // fallback –º–æ–ª—á–∞
      }
    }

    // ---- –ù–∞–≤–∏–≥–∞—Ü–∏—è
    $('btnStart').onclick = async ()=>{
      const r = await post('/api/game/start');
      if(r.ok){
        $('screenStart').classList.add('hidden');
        $('screenRole').classList.remove('hidden');
        adminUserId = r.game.admin_user_id;
        if(!es) connectSSE(); // –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –æ–¥–∏–Ω —Ä–∞–∑
      } else alert(r.error);
    };

    $('asAdmin').onclick = ()=>switchRole('admin');
    $('asPlayer').onclick = ()=>switchRole('player');

    function switchRole(role){
      currentRole = role;
      $('screenRole').classList.add('hidden');
      $('screenAdmin').classList.toggle('hidden', role!=='admin');
      $('screenPlayer').classList.toggle('hidden', role!=='player');
      if(role==='admin'){ loadPending(); loadPlayers(); }
      else { loadMyHistory(); }
    }

    // ---- –ò–≥—Ä–æ–∫
    $('btnReq').onclick = async ()=>handleRequest('request');
    $('btnReturn').onclick = async ()=>handleRequest('return');

    async function handleRequest(type){
      const amt = parseInt(($('chipsInput').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type});
      if(!r.ok) alert(r.error); else $('chipsInput').value='';
      loadMyHistory();
    }

    async function loadMyHistory(){
      const r = await post('/api/player/history');
      const box = $('myHistory');
      box.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.history?.length){ box.innerHTML = '<i>–ù–µ—Ç –∑–∞—è–≤–æ–∫</i>'; return; }
      for(const item of r.history){
        const color = item.status==='approved' ? '#2ea043' : item.status==='rejected' ? '#da3633' : '#f0ad4e';
        const div=document.createElement('div');
        div.innerHTML = `<b>${item.type==='request'?'–ó–∞–ø—Ä–æ—Å':'–í–æ–∑–≤—Ä–∞—Ç'}</b> ¬∑ ${item.amount} ¬∑ <span style="color:${color}">${item.status}</span>`;
        box.appendChild(div);
      }
    }

    // ---- –ê–¥–º–∏–Ω
    $('adminReqBtn').onclick = async ()=>adminRequest('request');
    $('adminRetBtn').onclick = async ()=>adminRequest('return');
    $('btnRefresh').onclick = loadPending;
    $('btnPlayers').onclick = ()=>togglePlayers();
    $('btnEnd').onclick = async ()=>alert((await post('/api/admin/end')).ok ? '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞' : '–û—à–∏–±–∫–∞');
    $('btnChangeAdmin').onclick = async ()=>{
      const val = $('newAdminSelect').value;
      if(!val) return;
      const r = await post('/api/admin/change', { new_admin_user_id: val });
      if(r.ok){ adminUserId = val; alert('‚úÖ –ê–¥–º–∏–Ω –∏–∑–º–µ–Ω—ë–Ω'); }
      else alert(r.error);
    };

    async function adminRequest(type){
      const amt = parseInt(($('adminAmount').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type});
      if(!r.ok) alert(r.error); else $('adminAmount').value='';
      loadPending();
    }

    function togglePlayers(){
      const el = $('adminSectionPlayers');
      el.classList.toggle('hidden');
      if(!el.classList.contains('hidden')) loadPlayers();
    }

    async function loadPending(){
      const r = await post('/api/admin/pending');
      const list = $('reqList'), badge = $('badge');
      list.innerHTML = '';
      if(!r.ok){ list.textContent = r.error; badge.style.display='none'; return; }
      const items = r.requests || [];
      if(!items.length){ list.innerHTML = '<i>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</i>'; badge.style.display='none'; return; }
      badge.textContent = items.length; badge.style.display='';
      for(const it of items){
        const el = document.createElement('div');
        el.className = 'req';
        el.innerHTML = `<b>${it.first_name||'–ò–≥—Ä–æ–∫'} ${it.username?('@'+it.username):''}</b><br>
        ${it.type==='request'?'–ü—Ä–æ—Å–∏—Ç':'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç'} <b>${it.amount}</b> —Ñ–∏—à–µ–∫
        <div class="row" style="margin-top:6px">
          <button data-id="${it.id}" data-s="approved">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
          <button class="secondary" data-id="${it.id}" data-s="rejected">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>`;
        list.appendChild(el);
      }
      list.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = +btn.dataset.id, status = btn.dataset.s;
          const r = await post('/api/admin/decide', {id, status});
          if(!r.ok) alert(r.error);
          loadPending(); loadPlayers();
        };
      });
    }

    async function loadPlayers(){
      const r = await post('/api/admin/players');
      const box = $('playersList'), sel = $('newAdminSelect');
      box.innerHTML = ''; sel.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.players?.length){ box.innerHTML = '<i>–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</i>'; return; }
      for(const p of r.players){
        const color = p.diff>0 ? '#2ea043' : p.diff<0 ? '#da3633' : '#f0ad4e';
        const row = document.createElement('div');
        row.innerHTML = `<b>${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}</b> ‚Äî –≤—ã–¥–∞–Ω–æ: <b>${p.issued}</b>, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ: <b>${p.returned}</b>, –∏—Ç–æ–≥: <b style="color:${color}">${p.diff}</b>`;
        box.appendChild(row);
        const opt = document.createElement('option');
        opt.value = p.user_id; opt.textContent = `${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}`;
        sel.appendChild(opt);
      }
    }
  </script>
</body>
</html>
