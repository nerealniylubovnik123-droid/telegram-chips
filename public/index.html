<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chips Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {font-family:system-ui;background:#0e1117;color:#e6edf3;margin:0;padding:20px;}
    button {background:#2f81f7;border:none;padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;margin:4px 0;}
    input {padding:8px;border-radius:8px;border:1px solid #30363d;background:#161b22;color:#e6edf3;width:100%;box-sizing:border-box;}
    .card {background:#161b22;padding:16px;border-radius:12px;margin:10px 0;}
    h2 {margin:8px 0;}
    .hidden {display:none;}
    .req {padding:8px;margin:6px 0;border-radius:8px;background:#20262f;}
    .req.pending {border:1px solid #2f81f7;}
    .req.approved {border:1px solid #238636;}
    .req.rejected {border:1px solid #b62324;}
    .req-btns button{margin-right:6px;}
  </style>
</head>
<body>
  <h1>üé≤ Chips Game</h1>

  <div id="screenStart">
    <button id="btnStart">–ù–∞—á–∞—Ç—å / –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
  </div>

  <div id="screenRole" class="hidden">
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</h2>
    <button id="asAdmin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
    <button id="asPlayer">–ò–≥—Ä–æ–∫</button>
  </div>

  <div id="screenAdmin" class="hidden">
    <h2>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h2>
    <div class="card">
      <button id="btnRefresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã</button>
      <button id="btnEnd">üõë –ó–∞–∫–æ–Ω—á–∏—Ç—å –∏–≥—Ä—É</button>
    </div>
    <div id="reqList"></div>
  </div>

  <div id="screenPlayer" class="hidden">
    <h2>–ò–≥—Ä–æ–∫</h2>
    <div class="card">
      <input id="chipsInput" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫">
      <button id="btnReq">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ñ–∏—à–∫–∏</button>
      <button id="btnReturn">–í–µ—Ä–Ω—É—Ç—å —Ñ–∏—à–∫–∏</button>
    </div>
    <div id="playerOut"></div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    const $ = id => document.getElementById(id);
    const api = async (path, bodyObj={})=>{
      bodyObj.__initData = tg?.initData || "";
      bodyObj.__initDataUnsafe = JSON.stringify(tg?.initDataUnsafe || {});
      const res = await fetch(path, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(bodyObj)
      });
      return await res.json();
    };

    // --- Navigation ---
    $('btnStart').onclick = async ()=>{
      const r = await api('/api/game/start');
      if(r.ok){$('screenStart').classList.add('hidden');$('screenRole').classList.remove('hidden');}
      else alert(r.error);
    };

    $('asAdmin').onclick = ()=>{$('screenRole').classList.add('hidden');$('screenAdmin').classList.remove('hidden');loadRequests();};
    $('asPlayer').onclick = ()=>{$('screenRole').classList.add('hidden');$('screenPlayer').classList.remove('hidden');};

    // --- Player actions ---
    $('btnReq').onclick = async ()=>{
      const amt = parseInt($('chipsInput').value||'0');
      if(amt<=0)return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ >0');
      const r = await api('/api/player/request',{amount:amt,type:'request'});
      $('playerOut').innerHTML = r.ok ? "–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ" : r.error;
    };
    $('btnReturn').onclick = async ()=>{
      const amt = parseInt($('chipsInput').value||'0');
      if(amt<=0)return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ >0');
      const r = await api('/api/player/request',{amount:amt,type:'return'});
      $('playerOut').innerHTML = r.ok ? "–í–æ–∑–≤—Ä–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚ôªÔ∏è" : r.error;
    };

    // --- Admin actions ---
    async function loadRequests(){
      const res = await fetch('/api/admin/pending',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          __initData: tg?.initData || "",
          __initDataUnsafe: JSON.stringify(tg?.initDataUnsafe || {})
        })
      });
      const data = await res.json();
      const div = $('reqList');
      div.innerHTML='';
      if(!data.ok){div.innerText=data.error;return;}
      if(data.requests.length===0){div.innerHTML='<i>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤</i>';return;}
      data.requests.forEach(r=>{
        const el=document.createElement('div');
        el.className='req '+r.status;
        el.innerHTML=`<b>${r.first_name||'–ò–≥—Ä–æ–∫'} ${r.username?('@'+r.username):''}</b><br>
        ${r.type==='request'?'–ü—Ä–æ—Å–∏—Ç':'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç'} ${r.amount} —Ñ–∏—à–µ–∫<br>
        <small>${r.status}</small>
        <div class="req-btns">
          <button onclick="decide(${r.id},'approved')">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
          <button onclick="decide(${r.id},'rejected')">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>`;
        div.appendChild(el);
      });
    }

    async function decide(id, status){
      const r = await api('/api/admin/decide',{id,status});
      if(r.ok) loadRequests();
      else alert(r.error);
    }

    $('btnRefresh').onclick = loadRequests;
    $('btnEnd').onclick = async ()=>{
      const r = await api('/api/admin/end');
      alert(r.ok?'–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞':'–û—à–∏–±–∫–∞: '+r.error);
    };

    // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    setInterval(()=>{if(!$('screenAdmin').classList.contains('hidden'))loadRequests();},5000);
  </script>
</body>
</html>
