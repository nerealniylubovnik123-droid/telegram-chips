<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chips Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {font-family:system-ui;background:#0e1117;color:#e6edf3;margin:0;padding:20px;}
    button {background:#2f81f7;border:none;padding:10px 14px;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;margin:4px 0;}
    button.secondary{background:#30363d}
    input,select {padding:8px;border-radius:8px;border:1px solid #30363d;background:#161b22;color:#e6edf3;width:100%;box-sizing:border-box;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .card {background:#161b22;padding:16px;border-radius:12px;margin:10px 0;}
    h2 {margin:8px 0;}
    .hidden {display:none;}
    .req {padding:10px;margin:6px 0;border-radius:8px;background:#20262f;border:1px solid #2f81f7;}
    .list{font-size:14px}
    .list div{padding:6px 0;border-bottom:1px solid #2a313b}
    .badge{display:inline-block;min-width:18px;padding:2px 6px;border-radius:999px;background:#f0ad4e;color:#111;font-weight:700;margin-left:6px}
  </style>
</head>
<body>
  <h1>üé≤ Chips Game</h1>

  <div id="screenStart">
    <button id="btnStart">–ù–∞—á–∞—Ç—å / –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
  </div>

  <div id="screenRole" class="hidden">
    <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å:</h2>
    <button id="asAdmin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
    <button id="asPlayer">–ò–≥—Ä–æ–∫</button>
  </div>

  <!-- ADMIN -->
  <div id="screenAdmin" class="hidden">
    <h2>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</h2>

    <div class="card">
      <div class="row">
        <input id="adminAmount" type="number" placeholder="–°–∫–æ–ª—å–∫–æ —Ñ–∏—à–µ–∫ –≤–∑—è—Ç—å (–∞–¥–º–∏–Ω –∫–∞–∫ –∏–≥—Ä–æ–∫)" />
        <button id="adminReqBtn">–í–∑—è—Ç—å</button>
        <button id="adminRetBtn" class="secondary">–í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnRefresh">üîÑ –ó–∞—è–≤–∫–∏ <span id="badge" class="badge" style="display:none">0</span></button>
        <button id="btnPlayers" class="secondary">üë• –ò–≥—Ä–æ–∫–∏ –∏ —Å—É–º–º—ã</button>
        <button id="btnEnd" class="secondary">üõë –ó–∞–∫–æ–Ω—á–∏—Ç—å –∏–≥—Ä—É</button>
      </div>
    </div>

    <div id="adminSectionRequests" class="card">
      <h3>–ó–∞—è–≤–∫–∏ (–æ–∂–∏–¥–∞—é—Ç —Ä–µ—à–µ–Ω–∏—è)</h3>
      <div id="reqList"></div>
    </div>

    <div id="adminSectionPlayers" class="card hidden">
      <h3>–°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="playersList" class="list"></div>
      <div class="row" style="margin-top:10px">
        <select id="newAdminSelect"></select>
        <button id="btnChangeAdmin">–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
      </div>
    </div>
  </div>

  <!-- PLAYER -->
  <div id="screenPlayer" class="hidden">
    <h2>–ò–≥—Ä–æ–∫</h2>
    <div class="card">
      <div class="row">
        <input id="chipsInput" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫">
        <button id="btnReq">–ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button id="btnReturn" class="secondary">–í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>
    <div class="card">
      <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
      <div id="myHistory" class="list"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    const $ = id => document.getElementById(id);
    const initData = tg?.initData || "";
    const initDataUnsafe = JSON.stringify(tg?.initDataUnsafe || {});
    const userId = tg?.initDataUnsafe?.user?.id || tg?.initDataUnsafe?.user_id;
    const bodyWithAuth = (extra={}) => JSON.stringify(Object.assign({}, extra, {__initData:initData,__initDataUnsafe:initDataUnsafe}));

    async function post(path, payloadObj={}) {
      const res = await fetch(path, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: bodyWithAuth(payloadObj)
      });
      return await res.json();
    }

    let currentRole = null;
    let adminUserId = null;

    // ---- –ù–∞–≤–∏–≥–∞—Ü–∏—è
    $('btnStart').onclick = async ()=>{
      const r = await post('/api/game/start');
      if(r.ok){ 
        $('screenStart').classList.add('hidden');
        $('screenRole').classList.remove('hidden'); 
        adminUserId = r.game.admin_user_id;
      }
      else alert(r.error);
    };

    $('asAdmin').onclick = ()=>switchRole('admin');
    $('asPlayer').onclick = ()=>switchRole('player');

    function switchRole(role){
      currentRole = role;
      $('screenRole').classList.add('hidden');
      $('screenAdmin').classList.toggle('hidden', role!=='admin');
      $('screenPlayer').classList.toggle('hidden', role!=='player');
      if(role==='admin'){
        loadPending(); 
        loadPlayers(); 
        startAdminPolling();
      } else {
        loadMyHistory(); 
        startPlayerPolling();
      }
    }

    // ---- –ò–≥—Ä–æ–∫
    $('btnReq').onclick = async ()=>{
      const amt = parseInt(($('chipsInput').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type:'request'});
      if(!r.ok) alert(r.error); else $('chipsInput').value='';
      loadMyHistory();
    };

    $('btnReturn').onclick = async ()=>{
      const amt = parseInt(($('chipsInput').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type:'return'});
      if(!r.ok) alert(r.error); else $('chipsInput').value='';
      loadMyHistory();
    };

    async function loadMyHistory(){
      const r = await post('/api/player/history');
      const box = $('myHistory');
      box.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.history || r.history.length===0){ box.innerHTML = '<i>–ù–µ—Ç –∑–∞—è–≤–æ–∫</i>'; return; }
      for(const item of r.history){
        const div=document.createElement('div');
        div.innerHTML = `<b>${item.type==='request'?'–ó–∞–ø—Ä–æ—Å':'–í–æ–∑–≤—Ä–∞—Ç'}</b> ¬∑ ${item.amount} ¬∑ <b>${item.status}</b>`;
        box.appendChild(div);
      }
    }

    // ---- –ê–¥–º–∏–Ω
    $('adminReqBtn').onclick = async ()=>{
      const amt = parseInt(($('adminAmount').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type:'request'});
      if(!r.ok) alert(r.error); else $('adminAmount').value='';
      loadPending();
    };
    $('adminRetBtn').onclick = async ()=>{
      const amt = parseInt(($('adminAmount').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type:'return'});
      if(!r.ok) alert(r.error); else $('adminAmount').value='';
      loadPending();
    };

    $('btnRefresh').onclick = loadPending;
    $('btnPlayers').onclick = ()=>{
      $('adminSectionPlayers').classList.toggle('hidden');
      if(!$('adminSectionPlayers').classList.contains('hidden')) loadPlayers();
    };
    $('btnEnd').onclick = async ()=>{
      const r = await post('/api/admin/end');
      alert(r.ok ? '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞' : ('–û—à–∏–±–∫–∞: '+r.error));
    };
    $('btnChangeAdmin').onclick = async ()=>{
      const val = $('newAdminSelect').value;
      if(!val) return;
      const r = await post('/api/admin/change', { new_admin_user_id: val });
      if(!r.ok) alert(r.error);
      else {
        adminUserId = val;
        alert('‚úÖ –ê–¥–º–∏–Ω –∏–∑–º–µ–Ω—ë–Ω');
      }
    };

    async function loadPending(){
      const r = await post('/api/admin/pending');
      const list = $('reqList');
      const badge = $('badge');
      list.innerHTML = '';
      if(!r.ok){ list.textContent = r.error; badge.style.display='none'; return; }
      const items = r.requests || [];
      if(items.length===0){ list.innerHTML = '<i>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</i>'; badge.style.display='none'; return; }
      badge.textContent = items.length; badge.style.display='';
      for(const it of items){
        const el = document.createElement('div');
        el.className = 'req';
        el.innerHTML = `<b>${it.first_name||'–ò–≥—Ä–æ–∫'} ${it.username?('@'+it.username):''}</b><br>
          ${it.type==='request'?'–ü—Ä–æ—Å–∏—Ç':'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç'} <b>${it.amount}</b> —Ñ–∏—à–µ–∫
          <div class="row" style="margin-top:6px">
            <button data-id="${it.id}" data-s="approved">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
            <button class="secondary" data-id="${it.id}" data-s="rejected">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>`;
        list.appendChild(el);
      }
      list.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = parseInt(btn.getAttribute('data-id'), 10);
          const status = btn.getAttribute('data-s');
          const r = await post('/api/admin/decide', {id, status});
          if(!r.ok) alert(r.error);
          loadPending();
          loadPlayers();
        };
      });
    }

    async function loadPlayers(){
      const r = await post('/api/admin/players');
      const box = $('playersList');
      const sel = $('newAdminSelect');
      box.innerHTML = '';
      sel.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.players || r.players.length===0){ box.innerHTML = '<i>–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</i>'; return; }
      for(const p of r.players){
        const row = document.createElement('div');
        row.innerHTML = `<b>${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}</b> ‚Äî –≤—ã–¥–∞–Ω–æ: <b>${p.issued}</b>, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ: <b>${p.returned}</b>, —Ä–∞–∑–Ω–∏—Ü–∞: <b>${p.diff}</b>`;
        box.appendChild(row);

        const opt = document.createElement('option');
        opt.value = p.user_id;
        opt.textContent = `${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}`;
        sel.appendChild(opt);
      }
    }

    // ---- –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    async function checkRoleChange(){
      const r = await post('/api/game/start'); // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
      if(r.ok && r.game){
        if(adminUserId !== r.game.admin_user_id){
          adminUserId = r.game.admin_user_id;
          const isNowAdmin = String(adminUserId) === String(tg?.initDataUnsafe?.user?.id);
          if(isNowAdmin && currentRole !== 'admin'){
            alert('–í—ã —Å—Ç–∞–ª–∏ –Ω–æ–≤—ã–º –∞–¥–º–∏–Ω–æ–º');
            switchRole('admin');
          } else if(!isNowAdmin && currentRole === 'admin'){
            alert('–ê–¥–º–∏–Ω –∏–∑–º–µ–Ω—ë–Ω, –≤—ã –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω');
            switchRole('player');
          }
        }
      }
    }

    let playerTimer = null, adminTimer = null, roleTimer = null;
    function startPlayerPolling(){
      clearAllTimers();
      playerTimer = setInterval(loadMyHistory, 5000);
      roleTimer = setInterval(checkRoleChange, 5000);
    }
    function startAdminPolling(){
      clearAllTimers();
      adminTimer = setInterval(()=>{ loadPending(); checkRoleChange(); }, 5000);
    }
    function clearAllTimers(){
      if(playerTimer) clearInterval(playerTimer);
      if(adminTimer) clearInterval(adminTimer);
      if(roleTimer) clearInterval(roleTimer);
    }
  </script>
</body>
</html>
