<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé≤ Chips Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-dark: #0d1117; --bg-card: #161b22; --border: #30363d; --text: #e6edf3;
      --accent: #2f81f7; --green: #2ea043; --red: #da3633; --yellow: #f0ad4e; --shadow: 0 4px 10px rgba(0,0,0,0.25);
    }
    body{font-family:system-ui,sans-serif;background:linear-gradient(180deg,#0d1117 0%,#111820 100%);color:var(--text);margin:0;padding:20px}
    h1{text-align:center;font-weight:700;color:var(--accent);margin-bottom:20px}
    button{background:var(--accent);border:none;padding:10px 16px;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;transition:background .2s,transform .1s}
    button:hover{transform:scale(1.02);background:#3889f8}
    button.secondary{background:#30363d}
    button.secondary:hover{background:#3a414b}
    input,select{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text);width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:var(--shadow);margin:10px 0}
    .req{background:#1b212c;padding:10px;border-radius:10px;margin:6px 0;border-left:4px solid var(--accent)}
    .badge{display:inline-block;min-width:18px;padding:2px 6px;border-radius:999px;background:var(--yellow);color:#111;font-weight:700;margin-left:6px}
    .role-label{text-align:center;padding:6px 0;font-size:14px;color:var(--yellow)}
  </style>
</head>
<body>
  <h1>üé≤ Chips Game</h1>

  <audio id="ding" preload="auto"
    src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQgAAAAA//8AAP//AAD//wAA//8AAP//AAD//wAA/38AAP9/AAD/fwAA/38AAP9/AAD/fwAA/38AAP9/AAD/fwAA/38AAP9/AAA="/>
  <!-- –∫–æ—Ä–æ—Ç–∫–∏–π —â–µ–ª—á–æ–∫ (–Ω–∏–∑–∫–æ–±–∏—Ç–Ω—ã–π WAV), —á—Ç–æ–±—ã –Ω–µ –≥—Ä—É–∑–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Ñ–∞–π–ª—ã -->

  <div id="screenStart">
    <button id="btnStart">–ù–∞—á–∞—Ç—å / –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
  </div>

  <div id="screenRole" class="hidden">
    <div class="card">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</h2>
      <div class="row">
        <button id="asAdmin">üß© –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
        <button id="asPlayer">üéÆ –ò–≥—Ä–æ–∫</button>
      </div>
    </div>
  </div>

  <div id="screenAdmin" class="hidden">
    <div class="role-label">üëë –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>

    <div class="card">
      <div class="row">
        <input id="adminAmount" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫" />
        <button id="adminReqBtn">üí∞ –í–∑—è—Ç—å</button>
        <button id="adminRetBtn" class="secondary">‚ôªÔ∏è –í–µ—Ä–Ω—É—Ç—å</button>
        <button id="soundToggle" class="secondary">üîî –ó–≤—É–∫: –≤–∫–ª</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnRefresh">üîÑ –ó–∞—è–≤–∫–∏ <span id="badge" class="badge" style="display:none">0</span></button>
        <button id="btnPlayers" class="secondary">üë• –ò–≥—Ä–æ–∫–∏ –∏ —Å—É–º–º—ã</button>
        <button id="btnEnd" class="secondary">üõë –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
      </div>
    </div>

    <div id="adminSectionRequests" class="card">
      <h3>üì© –ó–∞—è–≤–∫–∏ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="reqList"></div>
    </div>

    <div id="adminSectionPlayers" class="card hidden">
      <h3>üë• –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="playersList" class="list"></div>
      <div class="row" style="margin-top:10px">
        <select id="newAdminSelect"></select>
        <button id="btnChangeAdmin">üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
      </div>
    </div>
  </div>

  <div id="screenPlayer" class="hidden">
    <div class="role-label">üéÆ –í—ã –∏–≥—Ä–æ–∫</div>

    <div class="card">
      <div class="row">
        <input id="chipsInput" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫">
        <button id="btnReq">üí∞ –ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button id="btnReturn" class="secondary">‚ôªÔ∏è –í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <h3>üßæ –ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
      <div id="myHistory" class="list"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp; tg?.expand();
    const $ = id => document.getElementById(id);

    const initData = tg?.initData || "";
    const initDataUnsafeObj = tg?.initDataUnsafe || {};
    const initDataUnsafe = JSON.stringify(initDataUnsafeObj);
    const userId = initDataUnsafeObj?.user?.id;

    const bodyWithAuth = (extra={}) => JSON.stringify(Object.assign({}, extra, {__initData:initData,__initDataUnsafe:initDataUnsafe}));
    async function post(path, payloadObj={}) {
      const res = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, body: bodyWithAuth(payloadObj) });
      return await res.json();
    }

    let currentRole = null;
    let adminUserId = null;
    let es = null; // EventSource –¥–ª—è –∞–¥–º–∏–Ω–∞
    let soundOn = (localStorage.getItem('soundOn') ?? 'true') === 'true';

    function updateSoundToggle(){
      $('soundToggle')?.classList.toggle('secondary', !soundOn);
      $('soundToggle')?.innerText = soundOn ? 'üîî –ó–≤—É–∫: –≤–∫–ª' : 'üîï –ó–≤—É–∫: –≤—ã–∫–ª';
    }

    $('btnStart').onclick = async ()=>{
      const r = await post('/api/game/start');
      if(r.ok){ 
        $('screenStart').classList.add('hidden');
        $('screenRole').classList.remove('hidden'); 
        adminUserId = r.game.admin_user_id;
      } else alert(r.error);
    };

    $('asAdmin').onclick = ()=>switchRole('admin');
    $('asPlayer').onclick = ()=>switchRole('player');

    function switchRole(role){
      currentRole = role;
      $('screenRole').classList.add('hidden');
      $('screenAdmin').classList.toggle('hidden', role!=='admin');
      $('screenPlayer').classList.toggle('hidden', role!=='player');

      if(role==='admin'){
        updateSoundToggle();
        attachSSE(); // –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
        loadPending();
        loadPlayers();
      } else {
        detachSSE();
        loadMyHistory();
      }
    }

    // ---- –ò–≥—Ä–æ–∫
    $('btnReq').onclick = async ()=>handleRequest('request');
    $('btnReturn').onclick = async ()=>handleRequest('return');
    async function handleRequest(type){
      const amt = parseInt(($('chipsInput').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type});
      if(!r.ok) alert(r.error); else $('chipsInput').value='';
      loadMyHistory();
    }
    async function loadMyHistory(){
      const r = await post('/api/player/history');
      const box = $('myHistory');
      box.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.history?.length){ box.innerHTML = '<i>–ù–µ—Ç –∑–∞—è–≤–æ–∫</i>'; return; }
      for(const item of r.history){
        const stColor = item.status==='approved'?'#2ea043':item.status==='rejected'?'#da3633':'#f0ad4e';
        const div=document.createElement('div');
        div.innerHTML = `<b>${item.type==='request'?'–ó–∞–ø—Ä–æ—Å':'–í–æ–∑–≤—Ä–∞—Ç'}</b> ¬∑ ${item.amount} ¬∑ <span style="color:${stColor}">${item.status}</span>`;
        box.appendChild(div);
      }
    }

    // ---- –ê–¥–º–∏–Ω –∑–∞–ø—Ä–æ—Å—ã –∫–∞–∫ —É –∏–≥—Ä–æ–∫–∞
    $('adminReqBtn').onclick = async ()=>adminRequest('request');
    $('adminRetBtn').onclick = async ()=>adminRequest('return');
    async function adminRequest(type){
      const amt = parseInt(($('adminAmount').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type});
      if(!r.ok) alert(r.error); else $('adminAmount').value='';
      // –Ω–µ –∂–¥—ë–º ‚Äî SSE —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç —Å–ø–∏—Å–æ–∫
    }

    // ---- –ê–¥–º–∏–Ω: —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ / –∏–≥—Ä–æ–∫–æ–≤
    $('btnRefresh').onclick = loadPending;
    $('btnPlayers').onclick = ()=>togglePlayers();
    $('btnEnd').onclick = async ()=>alert((await post('/api/admin/end')).ok ? '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞' : '–û—à–∏–±–∫–∞');
    $('btnChangeAdmin').onclick = async ()=>{
      const val = $('newAdminSelect').value;
      if(!val) return;
      const r = await post('/api/admin/change', { new_admin_user_id: val });
      if(r.ok){ adminUserId = val; alert('‚úÖ –ê–¥–º–∏–Ω –∏–∑–º–µ–Ω—ë–Ω'); checkRoleChange(); } else alert(r.error);
    };
    $('soundToggle').onclick = ()=>{
      soundOn = !soundOn; localStorage.setItem('soundOn', String(soundOn)); updateSoundToggle();
    };

    function togglePlayers(){
      const el = $('adminSectionPlayers');
      el.classList.toggle('hidden');
      if(!el.classList.contains('hidden')) loadPlayers();
    }

    async function loadPending(){
      const r = await post('/api/admin/pending');
      const list = $('reqList'), badge = $('badge');
      list.innerHTML = '';
      if(!r.ok){ list.textContent = r.error; badge.style.display='none'; return; }
      const items = r.requests || [];
      if(!items.length){ list.innerHTML = '<i>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</i>'; badge.style.display='none'; return; }
      badge.textContent = items.length; badge.style.display='';
      for(const it of items){
        const el = document.createElement('div');
        el.className = 'req';
        el.innerHTML = `<b>${it.first_name||'–ò–≥—Ä–æ–∫'} ${it.username?('@'+it.username):''}</b><br>
          ${it.type==='request'?'–ü—Ä–æ—Å–∏—Ç':'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç'} <b>${it.amount}</b> —Ñ–∏—à–µ–∫
          <div class="row" style="margin-top:6px">
            <button data-id="${it.id}" data-s="approved">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
            <button class="secondary" data-id="${it.id}" data-s="rejected">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          </div>`;
        list.appendChild(el);
      }
      list.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = +btn.dataset.id, status = btn.dataset.s;
          const r = await post('/api/admin/decide', {id, status});
          if(!r.ok) alert(r.error);
          // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∂–µ –ø—Ä–∏–ª–µ—Ç–∏—Ç –ø–æ SSE, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π:
          loadPending(); loadPlayers();
        };
      });
    }

    async function loadPlayers(){
      const r = await post('/api/admin/players');
      const box = $('playersList'), sel = $('newAdminSelect');
      box.innerHTML = ''; sel.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.players?.length){ box.innerHTML = '<i>–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</i>'; return; }
      for(const p of r.players){
        const color = p.diff>0?'#2ea043':p.diff<0?'#da3633':'#f0ad4e';
        const row = document.createElement('div');
        row.innerHTML = `<b>${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}</b> ‚Äî –≤—ã–¥–∞–Ω–æ: <b>${p.issued}</b>, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ: <b>${p.returned}</b>, –∏—Ç–æ–≥: <b style="color:${color}">${p.diff}</b>`;
        box.appendChild(row);
        const opt = document.createElement('option');
        opt.value = p.user_id;
        opt.textContent = `${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}`;
        sel.appendChild(opt);
      }
    }

    // ---- –ê–≤—Ç–æ—Å–º–µ–Ω–∞ —Ä–æ–ª–∏ –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–¥–º–∏–Ω–∞
    async function checkRoleChange(){
      const r = await post('/api/game/start');
      if(r.ok && r.game){
        if(adminUserId !== r.game.admin_user_id){
          adminUserId = r.game.admin_user_id;
          const isNowAdmin = String(adminUserId) === String(userId);
          if(isNowAdmin && currentRole !== 'admin'){ alert('üéâ –í—ã —Å—Ç–∞–ª–∏ –Ω–æ–≤—ã–º –∞–¥–º–∏–Ω–æ–º'); switchRole('admin'); }
          else if(!isNowAdmin && currentRole === 'admin'){ alert('–ê–¥–º–∏–Ω –∏–∑–º–µ–Ω—ë–Ω, –≤—ã –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω'); switchRole('player'); }
        }
      }
    }

    // ---- SSE –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–∞–¥–º–∏–Ω)
    function attachSSE(){
      detachSSE();
      const url = `/sse/admin?initData=${encodeURIComponent(initData)}&initDataUnsafe=${encodeURIComponent(initDataUnsafe)}`;
      es = new EventSource(url);
      es.addEventListener('hello', e => {
        try {
          const data = JSON.parse(e.data||'{}');
          updateBadge(data.pending ?? 0);
        } catch {}
      });
      es.addEventListener('pending', e => {
        try {
          const data = JSON.parse(e.data||'{}');
          updateBadge(data.pending ?? null);
        } catch {}
        if(soundOn){ const a=$('ding'); a.currentTime=0; a.play().catch(()=>{}); }
        loadPending();
      });
      es.onerror = () => { /* –ø–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –ø–æ–∑–∂–µ */ };
    }
    function detachSSE(){
      if(es){ es.close(); es=null; }
    }
    function updateBadge(cnt){
      const b=$('badge');
      if(cnt===null || cnt===undefined){ b.style.display='none'; return; }
      if(cnt<=0){ b.style.display='none'; } else { b.textContent=cnt; b.style.display='inline-block'; }
    }
  </script>
</body>
</html>
