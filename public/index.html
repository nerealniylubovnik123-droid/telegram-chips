<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé≤ Chips Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --accent: #2f81f7;
      --green: #2ea043;
      --red: #da3633;
      --yellow: #f0ad4e;
      --shadow: 0 4px 10px rgba(0,0,0,0.25);
    }
    body{font-family:system-ui, sans-serif;background:linear-gradient(180deg,#0d1117 0%,#111820 100%);color:var(--text);margin:0;padding:20px;transition:all .3s ease}
    h1{text-align:center;font-weight:700;color:var(--accent);margin-bottom:20px}
    button{background:var(--accent);border:none;padding:10px 16px;border-radius:10px;color:#fff;font-weight:600;cursor:pointer;transition:background .2s,transform .1s}
    button:hover{transform:scale(1.02);background:#3889f8}
    button.secondary{background:#30363d;color:#e6edf3}
    button.secondary:hover{background:#3a414b}
    input,select{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card);color:var(--text);width:100%;box-sizing:border-box}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:var(--shadow);margin:10px 0;animation:fadeIn .4s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
    .req{background:#1b212c;padding:10px;border-radius:10px;margin:6px 0;border-left:4px solid var(--accent)}
    .req.pending{border-left-color:var(--yellow)}
    .req.approved{border-left-color:var(--green)}
    .req.rejected{border-left-color:var(--red)}
    .list{font-size:14px}
    .list div{padding:6px 0;border-bottom:1px solid #2a313b}
    .badge{display:inline-block;min-width:18px;padding:2px 6px;border-radius:999px;background:var(--yellow);color:#111;font-weight:700;margin-left:6px}
    .role-label{text-align:center;padding:6px 0;font-size:14px;color:var(--yellow)}
    .pulse{animation:pulse 1.2s ease 2}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(47,129,247,.7)}70%{box-shadow:0 0 0 12px rgba(47,129,247,0)}100%{box-shadow:0 0 0 0 rgba(47,129,247,0)}}
    .muted{color:#9da3ae}
  </style>
</head>
<body>
  <h1>üé≤ Chips Game</h1>

  <div id="screenStart">
    <button id="btnStart">–ù–∞—á–∞—Ç—å / –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    <div class="card" style="margin-top:12px">
      <h3>–°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã</h3>
      <div id="gameInfo" class="list"></div>
    </div>
  </div>

  <div id="screenRole" class="hidden">
    <div class="card">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</h2>
      <div class="row">
        <button id="asAdmin">üß© –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
        <button id="asPlayer">üéÆ –ò–≥—Ä–æ–∫</button>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="screenAdmin" class="hidden">
    <div class="role-label">üëë –í—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>

    <div class="card">
      <div class="row">
        <input id="adminAmount" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫" />
        <button id="adminReqBtn">üí∞ –í–∑—è—Ç—å</button>
        <button id="adminRetBtn" class="secondary">‚ôªÔ∏è –í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnRefresh">üîÑ –ó–∞—è–≤–∫–∏ <span id="badge" class="badge" style="display:none">0</span></button>
        <button id="btnPlayers" class="secondary">üë• –ò–≥—Ä–æ–∫–∏ –∏ —Å—É–º–º—ã</button>
        <button id="btnEnd" class="secondary">üõë –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
      </div>
    </div>

    <div id="adminSectionRequests" class="card">
      <h3>üì© –ó–∞—è–≤–∫–∏ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="reqList"></div>
    </div>

    <div id="adminSectionPlayers" class="card hidden">
      <h3>üë• –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤</h3>
      <div id="playersList" class="list"></div>
      <div class="row" style="margin-top:10px">
        <select id="newAdminSelect"></select>
        <button id="btnChangeAdmin">üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
      </div>
    </div>
  </div>

  <!-- PLAYER -->
  <div id="screenPlayer" class="hidden">
    <div class="role-label">üéÆ –í—ã –∏–≥—Ä–æ–∫</div>

    <div class="card">
      <div class="row">
        <input id="chipsInput" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∏—à–µ–∫">
        <button id="btnReq">üí∞ –ó–∞–ø—Ä–æ—Å–∏—Ç—å</button>
        <button id="btnReturn" class="secondary">‚ôªÔ∏è –í–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>

    <div class="card">
      <h3>üßæ –ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
      <div id="myHistory" class="list"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();

    const $ = id => document.getElementById(id);
    const initData = tg?.initData || "";
    const initDataUnsafe = JSON.stringify(tg?.initDataUnsafe || {});
    const userId = tg?.initDataUnsafe?.user?.id;
    const bodyWithAuth = (extra={}) => JSON.stringify(Object.assign({}, extra, {__initData:initData,__initDataUnsafe:initDataUnsafe}));

    async function post(path, payloadObj={}) {
      const res = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, body: bodyWithAuth(payloadObj) });
      return await res.json();
    }

    let currentRole = null;
    let adminUserId = null;
    let lastPendingCount = 0;

    // --- Start screen info
    async function loadGameInfo() {
      const box = $('gameInfo');
      box.innerHTML = '<span class="muted">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>';
      const r = await post('/api/game/info');
      if (!r.ok) { box.textContent = r.error || '–û—à–∏–±–∫–∞'; return; }
      if (!r.game) {
        box.innerHTML = '<div>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã</div>';
        return;
      }
      const a = r.admin;
      const who = `${a?.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}${a?.username ? ' @' + a.username : ''}`;
      box.innerHTML = `<div>–°—Ç–∞—Ç—É—Å: <b>–∞–∫—Ç–∏–≤–Ω–∞</b></div>
                       <div>–ê–¥–º–∏–Ω: <b>${who}</b></div>`;
      adminUserId = r.game.admin_user_id;
    }

    // --- Navigation
    $('btnStart').onclick = async ()=>{
      const r = await post('/api/game/start');
      if(r.ok){
        $('screenStart').classList.add('hidden');
        $('screenRole').classList.remove('hidden');
        adminUserId = r.game.admin_user_id;
      } else alert(r.error);
    };

    $('asAdmin').onclick = ()=>switchRole('admin');
    $('asPlayer').onclick = ()=>switchRole('player');

    function switchRole(role){
      currentRole = role;
      window.isAdminActive = (role === 'admin');
      $('screenRole').classList.add('hidden');
      $('screenAdmin').classList.toggle('hidden', role!=='admin');
      $('screenPlayer').classList.toggle('hidden', role!=='player');
      if(role==='admin'){
        loadPending(); loadPlayers(); startAdminPolling();
      } else {
        loadMyHistory(); startPlayerPolling();
      }
    }

    // --- Player actions
    $('btnReq').onclick = async ()=>handleRequest('request');
    $('btnReturn').onclick = async ()=>handleRequest('return');

    async function handleRequest(type){
      const amt = parseInt(($('chipsInput').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type});
      if(!r.ok) alert(r.error); else $('chipsInput').value='';
      loadMyHistory();
      if (window.isAdminActive) loadPending();
    }

    async function loadMyHistory(){
      const r = await post('/api/player/history');
      const box = $('myHistory');
      box.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.history?.length){ box.innerHTML = '<i>–ù–µ—Ç –∑–∞—è–≤–æ–∫</i>'; return; }
      for(const item of r.history){
        const color = item.status==='approved'?'#2ea043':item.status==='rejected'?'#da3633':'#f0ad4e';
        const div=document.createElement('div');
        div.innerHTML = `<b>${item.type==='request'?'–ó–∞–ø—Ä–æ—Å':'–í–æ–∑–≤—Ä–∞—Ç'}</b> ¬∑ ${item.amount} ¬∑ <span style="color:${color}">${item.status}</span>`;
        box.appendChild(div);
      }
    }

    // --- Admin actions
    $('adminReqBtn').onclick = async ()=>adminRequest('request');
    $('adminRetBtn').onclick = async ()=>adminRequest('return');

    async function adminRequest(type){
      const amt = parseInt(($('adminAmount').value||'0'), 10);
      if(amt<=0) return alert('–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ > 0');
      const r = await post('/api/player/request', {amount:amt, type});
      if(!r.ok) alert(r.error); else $('adminAmount').value='';
      loadPending();
    }

    $('btnRefresh').onclick = loadPending;
    $('btnPlayers').onclick = ()=>{
      $('adminSectionPlayers').classList.toggle('hidden');
      if(!$('adminSectionPlayers').classList.contains('hidden')) loadPlayers();
    };
    $('btnEnd').onclick = async ()=>{
      const r = await post('/api/admin/end');
      if (r.ok) {
        alert('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        resetToStart();
      } else {
        alert('–û—à–∏–±–∫–∞: ' + r.error);
      }
    };
    $('btnChangeAdmin').onclick = async ()=>{
      const val = $('newAdminSelect').value;
      if(!val) return;
      const r = await post('/api/admin/change', { new_admin_user_id: val });
      if(r.ok){ adminUserId = val; alert('‚úÖ –ê–¥–º–∏–Ω –∏–∑–º–µ–Ω—ë–Ω'); } else alert(r.error);
    };

    async function loadPending(){
      const r = await post('/api/admin/pending');
      const list = $('reqList'), badge = $('badge');
      list.innerHTML = '';
      if(!r.ok){ list.textContent = r.error; badge.style.display='none'; return; }

      const items = r.requests || [];
      if(items.length===0){ badge.style.display='none'; } else { badge.textContent = items.length; badge.style.display='inline-block'; }

      if (currentRole === 'admin') {
        const playersPanel = $('adminSectionPlayers');
        const requestsPanel = $('adminSectionRequests');

        if (items.length > lastPendingCount) {
          if (!playersPanel.classList.contains('hidden')) playersPanel.classList.add('hidden');
          requestsPanel.classList.add('pulse');
          requestsPanel.scrollIntoView({ behavior:'smooth', block:'start' });
          try { tg?.HapticFeedback?.notificationOccurred('success'); } catch(e){}
          setTimeout(()=>requestsPanel.classList.remove('pulse'), 1500);
        }
        lastPendingCount = items.length;
      }

      if(items.length===0){
        list.innerHTML = '<i>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</i>';
        return;
      }
      for(const it of items){
        const el = document.createElement('div');
        el.className = `req ${it.status}`;
        el.innerHTML = `<b>${it.first_name||'–ò–≥—Ä–æ–∫'} ${it.username?('@'+it.username):''}</b><br>
        ${it.type==='request'?'–ü—Ä–æ—Å–∏—Ç':'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç'} <b>${it.amount}</b> —Ñ–∏—à–µ–∫
        <div class="row" style="margin-top:6px">
          <button data-id="${it.id}" data-s="approved">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
          <button class="secondary" data-id="${it.id}" data-s="rejected">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>`;
        list.appendChild(el);
      }
      list.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async ()=>{
          const id = +btn.dataset.id, status = btn.dataset.s;
          const r = await post('/api/admin/decide', {id, status});
          if(!r.ok) alert(r.error);
          loadPending(); loadPlayers();
        };
      });
    }

    async function loadPlayers(){
      const r = await post('/api/admin/players');
      const box = $('playersList'), sel = $('newAdminSelect');
      box.innerHTML = ''; sel.innerHTML = '';
      if(!r.ok){ box.textContent = r.error; return; }
      if(!r.players?.length){ box.innerHTML = '<i>–ü–æ–∫–∞ –Ω–µ—Ç –∏–≥—Ä–æ–∫–æ–≤</i>'; return; }
      for(const p of r.players){
        const color = p.diff>0?'#2ea043':p.diff<0?'#da3633':'#f0ad4e';
        const row = document.createElement('div');
        row.innerHTML = `<b>${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}</b> ‚Äî –≤—ã–¥–∞–Ω–æ: <b>${p.issued}</b>, –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ: <b>${p.returned}</b>, –∏—Ç–æ–≥: <b style="color:${color}">${p.diff}</b>`;
        box.appendChild(row);

        const opt = document.createElement('option');
        opt.value = p.user_id;
        opt.textContent = `${p.first_name||'–ò–≥—Ä–æ–∫'} ${p.username?('@'+p.username):''}`;
        sel.appendChild(opt);
      }
    }

    // --- Role / game state helpers
    function resetToStart(){
      clearAll();
      currentRole = null;
      adminUserId = null;
      $('screenAdmin').classList.add('hidden');
      $('screenPlayer').classList.add('hidden');
      $('screenRole').classList.remove('hidden');
      $('screenStart').classList.remove('hidden');
      loadGameInfo();
      alert('üõë –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é.');
    }

    async function checkRoleChange(){
      const r = await post('/api/game/start');
      if (r.ok && r.game) {
        if (r.game.status === 'ended') {
          resetToStart();
          return;
        }
        if (adminUserId !== r.game.admin_user_id) {
          adminUserId = r.game.admin_user_id;
        }
      }
    }

    // --- Polling timers
    let playerTimer, adminTimer, roleTimer;
    function startPlayerPolling(){
      clearAll(); loadMyHistory();
      playerTimer = setInterval(loadMyHistory, 5000);
      roleTimer = setInterval(checkRoleChange, 5000);
    }
    function startAdminPolling(){
      clearAll(); loadPending();
      adminTimer = setInterval(()=>{ loadPending(); checkRoleChange(); }, 5000);
    }
    function clearAll(){
      clearInterval(playerTimer); clearInterval(adminTimer); clearInterval(roleTimer);
    }

    // initial load
    loadGameInfo();
  </script>
</body>
</html>
